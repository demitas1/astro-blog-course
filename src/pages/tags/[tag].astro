---
import { getCollection } from "astro:content"
import BaseLayout from "../../layouts/BaseLayout.astro"
import BlogPost from "../../components/BlogPost.astro"

export async function getStaticPaths() {
  const allPosts = await getCollection("posts")

  const allTags = [...(allPosts.map((post) => post.data.tags).flat())]
  const uniqueTags = [...(new Set(allTags))]

  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter((post) =>
      post.data.tags?.includes(tag),
    )

    return {
      params: {
        tag: tag,
      },
      props: {
        posts: filteredPosts,
      },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout pageTitle={tag}>
  <p>タグ {tag} がついた記事</p>
  <div>
    <ul>
      {
      posts.map((post) => (
          <BlogPost url={`/posts/${post.id}/`} title={post.data.title} />
        ))
      }
    </ul>
  </div>
</BaseLayout>
